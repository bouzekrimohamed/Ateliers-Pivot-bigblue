<!DOCTYPE html>
<html lang="fr">
<head>
   <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/8242/8242984.png">
  <meta charset="UTF-8" />
  <title>Convertisseur Excel ‚Üí CSV (BGB)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#0ea5e9; /* bleu clair */
      --primary-dark:#0284c7;
      --success:#22c55e; /* vert */
      --success-dark:#16a34a;
      --warning:#f59e0b;
      --ring:#bae6fd;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--text); line-height:1.45;
      display:flex; min-height:100vh; flex-direction:column;
    }
    .container{
      width:min(1100px, 92vw); margin:40px auto; padding:24px;
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
      border-bottom:1px solid #eef2f7; padding-bottom:16px; margin-bottom:20px;
    }
    h1{font-size:clamp(20px,3.5vw,28px); margin:0}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      display:inline-flex; align-items:center; gap:10px;
      padding:12px 18px; border:0; border-radius:12px; cursor:pointer;
      font-weight:700; color:white; transition:transform .18s ease, box-shadow .18s ease, background .18s ease;
      box-shadow:0 8px 18px rgba(2,132,199,.20);
    }
    .btn img.icon{width:22px; height:22px; object-fit:contain}
    .btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}
    .btn-blue{background:var(--primary)}
    .btn-blue:hover{background:var(--primary-dark); transform:translateY(-1px)}
    .btn-green{background:var(--success)}
    .btn-green:hover{background:var(--success-dark); transform:translateY(-1px)}
    .btn-purple{background:#8b5cf6}
    .btn-purple:hover{background:#7c3aed; transform:translateY(-1px)}
    .btn-warning{background:var(--warning)}
    .btn-warning:hover{background:#d97706; transform:translateY(-1px)}
    .btn-ghost{
      background:#eef6ff; color:#0b5cab; box-shadow:none;
      border:1px solid #dbeafe;
    }
    .btn-ghost:hover{background:#e0efff}
    /* Upload area */
    .uploader{
      margin:18px 0 8px; padding:26px; border:2px dashed #c7d2fe; border-radius:18px; background:#f8fafc;
      position:relative; text-align:center; transition:border-color .25s ease, background .25s ease;
      overflow:hidden;
    }
    .uploader:hover{border-color:#93c5fd; background:#f1f5f9}
    .uploader.glow{animation:glow 1.8s ease-in-out infinite}
    @keyframes glow{
      0%,100%{box-shadow:0 0 0 0 rgba(2,132,199,.25)}
      50%{box-shadow:0 0 0 12px rgba(2,132,199,.05)}
    }
    .uploader.drag{
      border-color:var(--primary); background:#eaf6ff;
    }
    .uploader input[type=file]{display:none}
    .uploader .label{
      display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:12px;
      background:white; border:1px solid #e5e7eb; cursor:pointer; font-weight:600;
      transition:transform .18s ease, box-shadow .18s ease;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    .uploader .label:hover{transform:translateY(-1px)}
    .uploader .hint{color:var(--muted); margin-top:10px; font-size:14px}
    .file-name{margin-top:10px; font-weight:600; color:#0b5cab}
    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .badge{
      background:#eff6ff; color:#1e40af; border:1px solid #dbeafe; border-radius:999px; padding:5px 10px; font-size:12px; font-weight:700;
    }
    /* Spinner + status */
    #spinner{display:none; margin:16px 0 6px}
    .spinner{
      width:44px; height:44px; border-radius:999px; border:5px solid #e5e7eb; border-top-color:var(--primary);
      animation:spin 1s linear infinite; margin:0 auto 8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    #status{color:var(--muted); text-align:center; font-size:14px}
    /* Modal Aide */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.45); padding:18px; z-index:50;
    }
    .modal.open{display:grid}
    .modal-card{
      background:var(--card); width:min(860px, 94vw); border-radius:18px; box-shadow:var(--shadow); padding:22px;
      max-height:85vh; overflow:auto;
    }
    .modal header{border:0; padding:0; margin:0 0 10px}
    .modal h2{margin:0; font-size:22px}
    .steps{margin:10px 0 0; padding-left:18px}
    .steps li{margin:8px 0}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px; font-weight:700}
    footer{
      margin-top:auto; padding:20px 0; text-align:center; color:#64748b; font-weight:600;
    }
    .divider{height:1px; background:#eef2f7; margin:18px 0}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Convertisseur Excel ‚Üí CSV (BGB)</h1>
      <div class="actions">
        <button class="btn btn-ghost" id="helpBtn" title="Aide / Mode d‚Äôemploi">
          <img class="icon" src="https://www.shutterstock.com/image-vector/support-icon-can-be-used-600nw-1887496465.jpg" alt="Aide"
               onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%230ea5e9%22/%3E%3Ctext x=%2212%22 y=%2216%22 text-anchor=%22middle%22 font-size=%2214%22 fill=%22white%22%3F%3E%3F%3C/text%3E%3C/svg%3E';">
          Aide
        </button>
        <button class="btn btn-ghost" id="updateBtn" title="Derni√®res mises √† jour">
          <img class="icon" src="https://cdn-icons-png.flaticon.com/512/2919/2919592.png" alt="Mises √† jour"
               onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%23f59e0b%22/%3E%3Ctext x=%2212%22 y=%2216%22 text-anchor=%22middle%22 font-size=%2214%22 fill=%22white%22%3E!%3C/text%3E%3C/svg%3E';">
          Mises √† jour
        </button>
        <button class="btn btn-purple" id="btnSftp" disabled>
          <img class="icon" src="https://cdn-icons-png.flaticon.com/512/8242/8242984.png" alt="SFTP">
          Envoyer sur SFTP
        </button>
        <button class="btn btn-warning" id="btnMerge" disabled>
          <img class="icon" src="https://cdn-icons-png.flaticon.com/512/2985/2985150.png" alt="Fusionner">
          Fusionner XLSM
        </button>
      </div>
      <img src="logo.png" alt="BigBlue Logo" style="height: 40px; margin-left: auto;">
    </header>
    <!-- Zone de s√©lection / drag & drop pour les 2 fichiers √† fusionner -->
    <div id="uploader" class="uploader glow">
      <label for="inputFile" class="label">
        üìÑ Choisir deux fichiers Excel √† fusionner
      </label>
      <input id="inputFile" type="file" accept=".xlsx,.xls,.xlsm" multiple />
      <div class="hint">Glisse-d√©pose tes fichiers ici ou clique pour les s√©lectionner (la 1√®re feuille sera lue). S√©lectionne exactement 2 fichiers pour fusionner.</div>
      <div class="badges">
        <span class="badge">Colonnes A,B,C ajout√©es (valeurs fixes)</span>
        <span class="badge">Colonnes r√©ordonn√©es/renomm√©es</span>
        <span class="badge">Export CSV en un clic</span>
      </div>
      <div id="fileName" class="file-name" aria-live="polite"></div>
    </div>
    <!-- Nouvelle zone pour charger le template apr√®s fusion -->
    <div id="templateUploader" class="uploader" style="display:none; margin-top:20px;">
      <label for="inputTemplate" class="label">
        üìÑ Choisir le fichier template Excel (avec 3 feuilles)
      </label>
      <input id="inputTemplate" type="file" accept=".xlsx,.xlsm" />
      <div class="hint">Charge le template pour coller la fusion dans 'extraction big blue'.</div>
      <div id="templateName" class="file-name" aria-live="polite"></div>
    </div>
    <!-- Nouvelle zone pour re-charger le fichier recalcul√© apr√®s ouverture dans Excel -->
    <div id="recalcUploader" class="uploader" style="display:none; margin-top:20px;">
      <label for="inputRecalc" class="label">
        üìÑ Re-charger le fichier apr√®s ouverture dans Excel
      </label>
      <input id="inputRecalc" type="file" accept=".xlsx,.xlsm" />
      <div class="hint">Ouvrez le fichier t√©l√©charg√© dans Excel pour recalculer les formules, enregistrez-le, puis re-chargez-le ici pour continuer les traitements.</div>
      <div id="recalcName" class="file-name" aria-live="polite"></div>
    </div>
    <div id="spinner" aria-live="polite">
      <div class="spinner"></div>
      <div id="status">Conversion en cours‚Ä¶</div>
    </div>
    <div class="divider"></div>
    <section>
      <h3 style="margin:6px 0 8px">Ce que fait l‚Äôoutil (r√©sum√©)</h3>
      <ol class="steps">
        <li>Charge 2 fichiers Excel et fusionne leurs premi√®res feuilles.</li>
        <li>Charge le template Excel avec la feuille 'extraction big blue'.</li>
        <li>Colle le tableau fusionn√© √† partir de A2 dans 'extraction big blue' et t√©l√©charge pour recalcul en Excel.</li>
        <li>Re-charge le fichier apr√®s ouverture en Excel.</li>
        <li>Applique les traitements de suppression et modifications sp√©cifiques.</li>
        <li>V√©rifie les erreurs (ICPE N/A avec B non vide) : si erreur, t√©l√©charge pour correction manuelle ; sinon, t√©l√©charge pour v√©rification et envoie via SFTP le CSV final.</li>
      </ol>
    </section>
  </div>
  <footer>
    Kuehne+Nagel ‚Äî Tous droits r√©serv√©s ‚Äî Made by <a href="mailto:mohamed.bouzekri@kuehne-nagel.com">Mohamed Bouzekri</a>
  </footer>
  <!-- Modal Aide -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="modal-card">
      <header style="display:flex;align-items:center;justify-content:space-between">
        <h2 id="helpTitle">Aide ‚Äî Mode d‚Äôemploi pas √† pas</h2>
        <button class="btn btn-ghost" id="closeHelp">Fermer ‚úï</button>
      </header>
      <ol class="steps">
        <li>Clique sur <strong>Choisir deux fichiers Excel</strong> ou d√©pose-les dans la zone gris√©e.</li>
        <li>Clique sur <strong>Fusionner XLSM</strong> pour fusionner.</li>
        <li>Charge le template via la nouvelle zone qui appara√Æt.</li>
        <li>Le fichier est t√©l√©charg√© automatiquement. Ouvrez-le dans Excel pour recalculer les formules, enregistrez, puis re-chargez via la zone suivante.</li>
        <li>L'outil applique traitements et v√©rifie erreurs.</li>
        <li>Si pas d'erreur, le fichier final est t√©l√©charg√© pour v√©rification, et clique <strong>Envoyer sur SFTP</strong> pour exporter le CSV final.</li>
        <li>Tout se fait localement dans ton navigateur ‚Äî aucune donn√©e envoy√©e sauf via SFTP.</li>
      </ol>
    </div>
  </div>
  <!-- Modal Mises √† jour -->
  <div id="updateModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="updateTitle">
    <div class="modal-card">
      <header style="display:flex;align-items:center;justify-content:space-between">
        <h2 id="updateTitle">Derni√®res mises √† jour de l‚Äôoutil</h2>
        <button class="btn btn-ghost" id="closeUpdate">Fermer ‚úï</button>
      </header>
      <ul class="steps">
        <li><strong>Version actuelle (23/12/2025) :</strong> Ajout d'un traitement pour supprimer toutes les lignes o√π la colonne H = 'SNDS'. Pr√©c√©demment : Dans la derni√®re √©tape, le fichier final et le CSV ne contiennent que la feuille 'extraction big blue'.</li>
        <li><strong>Pr√©c√©dente mise √† jour :</strong> Mise √† jour de la biblioth√®que SheetJS vers la version 0.20.3 pour corriger l'erreur 'invalid array length' avec les fichiers larges. T√©l√©charge la derni√®re version de xlsx.full.min.js depuis https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js et remplace le fichier dans ton r√©pertoire. Ajout de compression:true dans XLSX.write pour r√©duire la taille des fichiers. Limitation des colonnes lues √† O pour la fusion et AD pour le recalcul en utilisant l'option range dans sheet_to_json pour √©viter les erreurs de longueur d'array invalide.</li>
        <li><strong>Anciennes versions :</strong> Suppression automatique des ; et , (sauf dans PH_DG), d√©tection de colonnes irr√©guli√®res avec blocage et export des erreurs.</li>
      </ul>
    </div>
  </div>
  <!-- Lib XLSX (locale) -->
  <script src="xlsx.full.min.js"></script>
  <script>
    // Utilitaires
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const uploader = $('#uploader');
    const inputFile = $('#inputFile');
    const fileName = $('#fileName');
    const spinner = $('#spinner');
    const statusEl = $('#status');
    const btnSftp = $('#btnSftp');
    const btnMerge = $('#btnMerge');
    const helpBtn = $('#helpBtn');
    const helpModal = $('#helpModal');
    const closeHelp = $('#closeHelp');
    const updateBtn = $('#updateBtn');
    const updateModal = $('#updateModal');
    const closeUpdate = $('#closeUpdate');
    const templateUploader = $('#templateUploader');
    const inputTemplate = $('#inputTemplate');
    const templateName = $('#templateName');
    const recalcUploader = $('#recalcUploader');
    const inputRecalc = $('#inputRecalc');
    const recalcName = $('#recalcName');
    let mergedTable = null; // Stocke le tableau fusionn√©
    let finalWb = null; // Stocke le workbook final apr√®s traitements

    // Ajout des listeners une seule fois
    inputTemplate.addEventListener('change', processTemplate);
    inputRecalc.addEventListener('change', processRecalc);

    // Ouverture/fermeture Aide
    helpBtn.addEventListener('click', ()=> helpModal.classList.add('open'));
    closeHelp.addEventListener('click', ()=> helpModal.classList.remove('open'));
    helpModal.addEventListener('click', (e)=>{ if(e.target===helpModal) helpModal.classList.remove('open'); });
    // Ouverture/fermeture Mises √† jour
    updateBtn.addEventListener('click', ()=> updateModal.classList.add('open'));
    closeUpdate.addEventListener('click', ()=> updateModal.classList.remove('open'));
    updateModal.addEventListener('click', (e)=>{ if(e.target===updateModal) updateModal.classList.remove('open'); });
    // Drag & drop animations
    ;['dragenter','dragover'].forEach(evt => {
      uploader.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); uploader.classList.add('drag'); });
    });
    ;['dragleave','drop'].forEach(evt => {
      uploader.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); uploader.classList.remove('drag'); });
    });
    uploader.addEventListener('drop', (e)=>{
      const files = e.dataTransfer.files;
      if (files.length !== 2) {
        alert("S√©lectionnez exactement 2 fichiers.");
        return;
      }
      inputFile.files = files;
      onFileChosen();
    });
    // Choix de fichier
    inputFile.addEventListener('change', onFileChosen);
    function onFileChosen(){
      const files = inputFile.files;
      if(!files.length){ return; }
      if (files.length !== 2) {
        alert("S√©lectionnez exactement 2 fichiers.");
        inputFile.value = '';
        return;
      }
      let names = Array.from(files).map(f => f.name).join(' et ');
      fileName.textContent = `Fichier(s) s√©lectionn√©(s) : ${names}`;
      btnMerge.disabled = false;
      uploader.classList.remove('glow');
      templateUploader.style.display = 'none';
      recalcUploader.style.display = 'none';
    }
    // Boutons
    btnMerge.addEventListener('click', mergeFiles);
    btnSftp.addEventListener('click', sendToSftp);
    // Convertit un tableau JS -> CSV (√©chappement correct)
    function toCSV(rows, delimiter = ';'){
      const esc = v => {
        if (v === null || v === undefined) return '';
        const s = String(v).trim();
        return (s.includes('"') || s.includes('\n') || s.includes('\r') || s.includes(delimiter))
          ? `"${s.replace(/"/g,'""')}"`
          : s;
      };
      return rows.map(r => r.map(esc).join(delimiter)).join('\n');
    }
    // Validation des valeurs pour √©viter les rejets et supprimer ; (garder , pour √©viter d√©calages)
    function cleanValue(value, field) {
      if (value === null || value === undefined) return '';
      let str = String(value).trim();
      // Supprimer ; dans tous les champs (remplacer par espace)
      str = str.replace(/;/g, ' ');
      if (field === 'CSV.Designation_V') {
        // Nettoyer D√©signation vulgaris√©e
        if (['LC', '0', 'Hygiene - Beaut√©', 'SLC'].includes(str) || str === '') {
          return 'Inconnu';
        }
        return str.substring(0, 45); // Limite √† 45 caract√®res
      }
      if (field === 'CSV.Risque_P') {
        // Nettoyer Risque particulier
        if (['0', 'Solide', 'Liquide'].includes(str) || str === '') {
          return '';
        }
        return str;
      }
      if (field === 'CSV.ICPE') {
        // ICPE : laisser vide si non valide
        if (['MUJI'].includes(str) || str === '') {
          return '';
        }
        return str;
      }
      // Pas de suppression de , (gard√©es partout pour phrases de danger etc.)
      return str;
    }
    // Gestion des erreurs (affichage message + bouton export erreurs)
    function handleErrors(errorRows) {
      statusEl.textContent = 'Erreur : Colonnes irr√©guli√®res ou champs requis vides d√©tect√©s. Conversion bloqu√©e.';
  
      // Cr√©er bouton pour exporter les erreurs
      let errBtn = document.createElement('button');
      errBtn.id = 'errorBtn';
      errBtn.textContent = 'Exporter les erreurs';
      errBtn.classList.add('btn', 'btn-warning');
      spinner.after(errBtn);
      errBtn.addEventListener('click', () => {
        let errOut = [['Ligne', 'Type', 'D√©tails']];
        errorRows.forEach(er => errOut.push([er.row, er.type, er.details]));
        let csv = toCSV(errOut, ';');
        let blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'erreurs_fichier.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    }
    // Fonction pour envoyer le CSV au serveur backend
    async function uploadToServer(csv, filename) {
      const formData = new FormData();
      formData.append("file", new Blob([csv], {type:"text/csv"}), filename);
      try {
        let res = await fetch("http://localhost:5000/upload", {
          method: "POST",
          body: formData
        });
        let txt = await res.text();
        statusEl.textContent = '‚úÖ Envoi SFTP termin√©.';
        alert("Serveur : " + txt);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Erreur lors de l‚Äôenvoi SFTP.';
        alert("Erreur lors de l‚Äôenvoi au serveur : " + err.message);
      }
    }
    // Fonction pour lire un fichier en Promise
    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(new Uint8Array(e.target.result));
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
    // Fonction de fusion des deux fichiers
    async function mergeFiles() {
      const files = inputFile.files;
      if (files.length !== 2) {
        alert("S√©lectionnez exactement 2 fichiers.");
        return;
      }
      spinner.style.display = 'block';
      statusEl.textContent = 'Fusion des fichiers‚Ä¶';
      try {
        const data1 = await readFile(files[0]);
        const wb1 = XLSX.read(data1, { type: 'array' });
        const ws1 = wb1.Sheets[wb1.SheetNames[0]];
        let ref1 = XLSX.utils.decode_range(ws1['!ref'] || "A1:O1048576");
        ref1.e.c = 14; // O column, 0-indexed
        const limitedRef1 = XLSX.utils.encode_range(ref1);
        let table1 = XLSX.utils.sheet_to_json(ws1, { header: 1, range: limitedRef1 });
        const data2 = await readFile(files[1]);
        const wb2 = XLSX.read(data2, { type: 'array' });
        const ws2 = wb2.Sheets[wb2.SheetNames[0]];
        let ref2 = XLSX.utils.decode_range(ws2['!ref'] || "A1:O1048576");
        ref2.e.c = 14;
        const limitedRef2 = XLSX.utils.encode_range(ref2);
        let table2 = XLSX.utils.sheet_to_json(ws2, { header: 1, range: limitedRef2 }).slice(1);
        // V√©rifier le m√™me nombre de colonnes
        if (table1[0] && table2[0] && table1[0].length !== table2[0].length) {
          throw new Error("Les fichiers n'ont pas le m√™me nombre de colonnes.");
        }
        // Normaliser les longueurs (padding) MAIS on limite √† A‚ÜíO (15 colonnes)
        let allRows = table1.concat(table2);

        // Calcul maxCols SANS spread
        let maxCols = 0;
        for (const row of allRows) {
          const len = row ? row.length : 0;
          if (len > maxCols) maxCols = len;
        }

        // On ne garde que 15 colonnes (A‚ÜíO)
        maxCols = Math.min(maxCols, 15);

        // Couper + pad √† 15
        allRows = allRows.map(row => {
          row = row || [];
          let cut = row.slice(0, maxCols);
          while (cut.length < maxCols) cut.push('');
          return cut;
        });

        mergedTable = allRows;
        // Appliquer nettoyage initial sur mergedTable
        for (let r = 1; r < mergedTable.length; r++) {
          mergedTable[r] = mergedTable[r].map((v, c) => cleanValue(v, mergedTable[0][c] || `Col${c}`));
        }
        statusEl.textContent = '‚úÖ Fusion termin√©e. Charge maintenant le template.';
        // Afficher uploader pour template
        templateUploader.style.display = 'block';
      } catch (err) {
        console.error(err);
        alert('Erreur: ' + err.message);
        statusEl.textContent = 'Erreur pendant la fusion.';
      } finally {
        setTimeout(() => { spinner.style.display = 'none'; }, 500);
      }
    }
    // Fonction pour traiter le template : collage et t√©l√©chargement pour recalcul
    async function processTemplate() {
      const f = inputTemplate.files[0];
      if (!f) return;
      templateName.textContent = `Template : ${f.name}`;
      spinner.style.display = 'block';
      statusEl.textContent = 'Collage dans le template‚Ä¶';
      try {
        const data = await readFile(f);
        const wb = XLSX.read(data, { type: 'array', cellFormula: true, cellDates: true }); // Pr√©serve formules
        const sheetName = 'extraction big blue';
        if (!wb.SheetNames.includes(sheetName)) {
          throw new Error('Feuille "extraction big blue" manquante dans le template.');
        }
        const ws = wb.Sheets[sheetName];
        let dataRows = mergedTable.slice(1);

        // Forcer exactement A‚ÜíO (15 colonnes)
        const dataCols = 15;
        dataRows = dataRows.map(row => {
          row = row || [];
          let newRow = row.slice(0, dataCols);
          while (newRow.length < dataCols) newRow.push('');
          return newRow;
        });
        // Coller
        XLSX.utils.sheet_add_aoa(ws, dataRows, {origin: 'A2'});
        // T√©l√©charger le fichier pour recalcul dans Excel
        statusEl.textContent = 'T√©l√©chargement du fichier pour recalcul dans Excel‚Ä¶';
        const outData = XLSX.write(wb, { bookType: 'xlsm', type: 'array', compression: true });
        const blob = new Blob([outData], { type: 'application/vnd.ms-excel.sheet.macroEnabled.12' });
        const a = document.createElement('a');
        const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.href = URL.createObjectURL(blob);
        a.download = `template_colle_${today}.xlsm`;
        a.click();
        URL.revokeObjectURL(a.href);
        statusEl.textContent = '‚úÖ Fichier t√©l√©charg√©. Ouvrez-le dans Excel, recalculez (Ctrl+Alt+F9 si needed), enregistrez, puis re-chargez ici.';
        // Afficher uploader pour fichier recalcul√©
        recalcUploader.style.display = 'block';
      } catch (err) {
        console.error(err);
        alert('Erreur: ' + err.message);
        statusEl.textContent = 'Erreur pendant le collage.';
      } finally {
        setTimeout(() => { spinner.style.display = 'none'; }, 500);
      }
    }
    // Fonction pour traiter le fichier re-charg√© apr√®s recalcul
    async function processRecalc() {
      const f = inputRecalc.files[0];
      if (!f) return;
      recalcName.textContent = `Fichier recalcul√© : ${f.name}`;
      spinner.style.display = 'block';
      statusEl.textContent = 'Lecture du fichier recalcul√©‚Ä¶';
      try {
        const data = await readFile(f);
        const wb = XLSX.read(data, { type: 'array', cellFormula: true, cellDates: true });
        const sheetName = 'extraction big blue';
        if (!wb.SheetNames.includes(sheetName)) {
          throw new Error('Feuille "extraction big blue" manquante.');
        }
        const ws = wb.Sheets[sheetName];
        // Limiter la range √† A:AD pour √©viter erreurs
        let ref = XLSX.utils.decode_range(ws['!ref'] || "A1:AD1048576");
        ref.e.c = 29; // AD column, 0-indexed
        const limitedRef = XLSX.utils.encode_range(ref);
        let updatedTable = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, range: limitedRef});
        // Appliquer les traitements
        statusEl.textContent = 'Application des traitements‚Ä¶';
        updatedTable = applyPostFormulaTreatments(updatedTable);
        // Mettre √† jour le sheet
        wb.Sheets[sheetName] = XLSX.utils.aoa_to_sheet(updatedTable);
        // Supprimer les autres feuilles
        wb.SheetNames.forEach(name => {
          if (name !== sheetName) {
            delete wb.Sheets[name];
          }
        });
        wb.SheetNames = [sheetName];
        // V√©rifier erreurs
        statusEl.textContent = 'V√©rification des erreurs‚Ä¶';
        let errorRows = checkErrors(updatedTable);
        if (errorRows.length > 0) {
          statusEl.textContent = 'Erreur : ICPE N/A avec B non vide d√©tect√©. T√©l√©chargement pour correction manuelle.';
          // T√©l√©charger pour correction
          const outData = XLSX.write(wb, { bookType: 'xlsm', type: 'array', compression: true });
          const blob = new Blob([outData], { type: 'application/vnd.ms-excel.sheet.macroEnabled.12' });
          const a = document.createElement('a');
          const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          a.href = URL.createObjectURL(blob);
          a.download = `template_erreurs_${today}.xlsm`;
          a.click();
          URL.revokeObjectURL(a.href);
        } else {
          finalWb = wb;
          statusEl.textContent = '‚úÖ Tout est OK. T√©l√©chargement du fichier final pour v√©rification.';
          // T√©l√©charger le final pour vue
          const outData = XLSX.write(wb, { bookType: 'xlsm', type: 'array', compression: true });
          const blob = new Blob([outData], { type: 'application/vnd.ms-excel.sheet.macroEnabled.12' });
          const a = document.createElement('a');
          const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
          a.href = URL.createObjectURL(blob);
          a.download = `final_${today}.xlsm`;
          a.click();
          URL.revokeObjectURL(a.href);
          // Activer SFTP
          btnSftp.disabled = false;
        }
      } catch (err) {
        console.error(err);
        alert('Erreur: ' + err.message);
        statusEl.textContent = 'Erreur pendant le traitement du fichier recalcul√©.';
      } finally {
        setTimeout(() => { spinner.style.display = 'none'; }, 500);
      }
    }
    // Fonction pour appliquer les traitements apr√®s formules
    function applyPostFormulaTreatments(table) {
      if (!table || table.length < 2) return table;
      const headers = table[0];
      // Trouver indices des colonnes par lettres (A=0, B=1, ..., AD=29)
      const idx = {
        B: 1, // Probablement WMS_Ref ou similaire
        C: 2, // Designation
        H: 7, // Supplier
        T: 19, // ICPE
        U: 20, // Non sp√©cifi√©, assume bas√© sur contexte
        V: 21, // Cell
        AD: 29 // Designation_V
      };
      const isEmpty = v => v == null || v === '' || v === 'N/A';
      let filtered = [headers];
      for (let r = 1; r < table.length; r++) {
        let row = table[r];
        // √âtape 3 : cas BIGW
        if (row[idx.H] === 'BIGW' && typeof row[idx.B] === 'string' && row[idx.B].startsWith('BIGW-PALLET-')) {
          row[idx.H] = 'bigp';
          row[idx.T] = '1532';
        }
        // Nouvelle suppression : toutes les lignes o√π H = 'SNDS'
        if (row[idx.H] === 'SNDS') continue;
        // Suppressions existantes (sans la condition sur AD pour SNDS, car d√©j√† g√©r√©e ci-dessus)
        if (!row[idx.C] && isEmpty(row[idx.AD])) continue;
        if (isEmpty(row[idx.T]) && !row[idx.B]) continue;
        if ((isEmpty(row[idx.U]) || isEmpty(row[idx.V])) && !row[idx.B]) continue;
        if (!row[idx.B] && isEmpty(row[idx.T])) continue;
        filtered.push(row);
      }
      return filtered;
    }
    // Fonction pour v√©rifier erreurs ICPE
    function checkErrors(table) {
      let errors = [];
      const isEmpty = v => v == null || v === '' || v === 'N/A';
      for (let r = 1; r < table.length; r++) {
        const row = table[r];
        if (isEmpty(row[19]) && row[1]) { // T=19 (ICPE), B=1 non vide
          errors.push(r + 1); // Ligne 1-based
        }
      }
      return errors;
    }
    // Fonction pour envoyer le CSV final via SFTP
    function sendToSftp() {
      if (!finalWb) {
        alert("Aucun fichier pr√™t pour l'envoi.");
        return;
      }
      spinner.style.display = 'block';
      statusEl.textContent = 'G√©n√©ration du CSV final‚Ä¶';
      try {
        const ws = finalWb.Sheets['extraction big blue'];
        let ref = XLSX.utils.decode_range(ws['!ref'] || "A1:AD1048576");
        ref.e.c = 29; // AD
        const limitedRef = XLSX.utils.encode_range(ref);
        const finalTable = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, range: limitedRef });
        const csv = toCSV(finalTable);
        const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
        const filename = `ESRST_BGBHTS3_${today}001.ESR`;
        uploadToServer(csv, filename);
      } catch (err) {
        console.error(err);
        alert('Erreur: ' + err.message);
        statusEl.textContent = 'Erreur pendant la g√©n√©ration du CSV.';
      } finally {
        setTimeout(() => { spinner.style.display = 'none'; }, 500);
      }
    }
  </script>
</body>
</html>